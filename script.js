const planDeEstudiosData = {
  "plan_de_estudios": "INGENIERÍA INDUSTRIAL",
  "años": [
    {
      "año": "PRIMER AÑO",
      "cuatrimestres": [
        {
          "cuatrimestre": "PRIMER CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4052",
              "asignatura": "Análisis Matemático I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4053",
              "asignatura": "Infraestructura Tecnológica",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4054",
              "asignatura": "Algebra y Geometría Analítica I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4055",
              "asignatura": "Física I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4056",
              "asignatura": "Sistemas de Representación",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4057",
              "asignatura": "Introducción al Ejercicio Profesional",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            }
          ]
        },
        {
          "cuatrimestre": "SEGUNDO CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4058",
              "asignatura": "Elementos de Economía",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4052"
            },
            {
              "codigo": "4059",
              "asignatura": "Análisis Matemático II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4052"
            },
            {
              "codigo": "4060",
              "asignatura": "Física II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4055"
            },
            {
              "codigo": "4061",
              "asignatura": "Fundamentos de Química",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": ""
            },
            {
              "codigo": "4062",
              "asignatura": "Álgebra y Geometría Analítica II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4054"
            },
            {
              "codigo": "4063",
              "asignatura": "Organización Industrial I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4057"
            }
          ]
        }
      ]
    },
    {
      "año": "SEGUNDO AÑO",
      "cuatrimestres": [
        {
          "cuatrimestre": "PRIMER CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4064",
              "asignatura": "Costos Industriales",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4058/4063"
            },
            {
              "codigo": "4065",
              "asignatura": "Análisis Matemático III",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4059"
            },
            {
              "codigo": "4066",
              "asignatura": "Ética Profesional y Legislación",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4057"
            },
            {
              "codigo": "4067",
              "asignatura": "Elementos de Programación",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4053"
            },
            {
              "codigo": "4068",
              "asignatura": "Física III",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4060"
            },
            {
              "codigo": "4069",
              "asignatura": "Materiales Industriales",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4059/4060/4061"
            }
          ]
        },
        {
          "cuatrimestre": "SEGUNDO CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4070",
              "asignatura": "Tecnología de Materiales y Procesos 1",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4069"
            },
            {
              "codigo": "4071",
              "asignatura": "Higiene, Seguridad e Ingeniería Ambiental",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4063/4066"
            },
            {
              "codigo": "4072",
              "asignatura": "Probabilidad y Estadística",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4062/4065"
            },
            {
              "codigo": "4073",
              "asignatura": "Química Industrial",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4061"
            },
            {
              "codigo": "4074",
              "asignatura": "Gestión de Operaciones I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4064"
            },
            {
              "codigo": "4075",
              "asignatura": "Electrotecnia y Máquinas Eléctricas",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4056/4068"
            }
          ]
        }
      ]
    },
    {
      "año": "TERCER AÑO",
      "cuatrimestres": [
        {
          "cuatrimestre": "PRIMER CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4076",
              "asignatura": "Termodinámica",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4060/4065/4073"
            },
            {
              "codigo": "4077",
              "asignatura": "Organización Industrial II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4063/4074"
            },
            {
            "codigo": "4078",
            "asignatura": "Tecnología de Materiales y Procesos 2",
            "horas_semanales": 4,
            "total_horas": 64,
            "correlatividad": "4070"
            },
            {
              "codigo": "4079",
              "asignatura": "Gestión de la Innovación y Emprendedorismo",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4069/4074"
            },
            {
              "codigo": "4080",
              "asignatura": "Estadística Aplicada",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4072"
            },
            {
              "codigo": "4081",
              "asignatura": "Gestión de Operaciones II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4074"
            }
          ]
        },
        {
          "cuatrimestre": "SEGUNDO CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4082",
              "asignatura": "Espacio de Integración Tecnológica",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4056/4070/4071/4075/4081"
            },
            {
              "codigo": "4083",
              "asignatura": "Máquinas Térmicas",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4060/4076"
            },
            {
              "codigo": "4084",
              "asignatura": "Gestión de la Calidad",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4080/4081"
            },
            {
              "codigo": "4085",
              "asignatura": "Mecánica de los Fluidos",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4076"
            },
            {
              "codigo": "4086",
              "asignatura": "Investigación Operativa",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4074/4080"
            }
          ]
        }
      ]
    },
    {
      "año": "CUARTO AÑO",
      "cuatrimestres": [
        {
          "cuatrimestre": "PRIMER CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4087",
              "asignatura": "Procesos Industriales I",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4073/4076/4082"
            },
            {
              "codigo": "4088",
              "asignatura": "Gestión Comercial",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4058/4077"
            },
            {
              "codigo": "4089",
              "asignatura": "Gestión Logística",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4081/4086"
            },
            {
              "codigo": "4090",
              "asignatura": "Finanzas de la Empresa",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4058/4064/4077/4081"
            },
            {
              "codigo": "4091",
              "asignatura": "Sistemas Informáticos de Gestión",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4067/4077"
            }
          ]
        },
        {
          "cuatrimestre": "SEGUNDO CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4092",
              "asignatura": "Gestión y Evaluación de Proyectos",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4082/4086/4090"
            },
            {
              "codigo": "4093",
              "asignatura": "Elementos de Máquinas y Mecanismos",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4056/4078/4083"
            },
            {
              "codigo": "4094",
              "asignatura": "Ecología Industrial y Desarrollo Sustentable",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4066/4087"
            },
            {
              "codigo": "4095",
              "asignatura": "Procesos Industriales II",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4087"
            },
            {
              "codigo": "4096",
              "asignatura": "Industrias de Servicios",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4084/4091"
            }
          ]
        }
      ]
    },
    {
      "año": "QUINTO AÑO",
      "cuatrimestres": [
        {
          "cuatrimestre": "PRIMER CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4097",
              "asignatura": "Responsabilidad Social Universitaria",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4082"
            },
            {
              "codigo": "4098",
              "asignatura": "Proyecto Final Integrador (*)",
              "horas_semanales": 4,
              "total_horas": 128,
              "correlatividad": "4081/4082/4088/4092/4095"
            },
            {
              "codigo": "4099",
              "asignatura": "Automatización Industrial",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4067/4075/4093"
            },
            {
              "codigo": "4106",
              "asignatura": "Electiva I (Sistemas de Gestión y Mejora Continua)",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4084/4091"
            }
          ]
        },
        {
          "cuatrimestre": "SEGUNDO CUATRIMESTRE",
          "materias": [
            {
              "codigo": "4101",
              "asignatura": "Instalaciones Industriales",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4083/4085/4099"
            },
            {
              "codigo": "4107",
              "asignatura": "Electiva II (Manejo y Distribución de Materiales)",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4089"
            },
            {
              "codigo": "4108",
              "asignatura": "Electiva III (Inteligencia Industrial)",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4079/4080/4091"
            },
            {
              "codigo": "4104",
              "asignatura": "Gestión Industrial",
              "horas_semanales": 4,
              "total_horas": 64,
              "correlatividad": "4088/4089/4092/4094/4095"
            },
            {
              "codigo": "4105",
              "asignatura": "Práctica Profesional Supervisada",
              "horas_semanales": "(**)",
              "total_horas": 200,
              "correlatividad": "4082"
            }
          ]
        }
      ]
    }
  ],
  "conocimientos_comunes_unlam": [
    {
      "codigo": "901",
      "asignatura": "Inglés Transversal Nivel I",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": ""
    },
    {
      "codigo": "902",
      "asignatura": "Inglés Transversal Nivel II",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": "901"
    },
    {
      "codigo": "903",
      "asignatura": "Inglés Transversal Nivel III",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": "902"
    },
    {
      "codigo": "904",
      "asignatura": "Inglés Transversal Nivel IV",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": "903"
    },
    {
      "codigo": "911",
      "asignatura": "Computación Transversal Nivel I",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": ""
    },
    {
      "codigo": "912",
      "asignatura": "Computación Transversal Nivel II",
      "horas_semanales": 4,
      "total_horas": 64,
      "correlatividad": "911"
    }
  ],
  "titulo_intermedio": {
    "nombre": "Título Intermedio",
    "requisitos": "Se obtiene con la aprobación de todas las asignaturas hasta 3er. año inclusive, taller EIT, Inglés Transversal 1 y 2 y Computación 1"
  },
  "titulo_final": "INGENIERO INDUSTRIAL",
  "notas": [
    "(*) Materia anual",
    "(**) La Práctica Profesional Supervisada implica una carga horaria de 200 horas de prácticas profesionalizantes en ámbitos laborales."
  ]
};
// TERMINA EL JSON AQUI

const mallaCurricular = document.getElementById('malla-curricular');
const infoMateriaPanel = document.getElementById('info-materia');
const detalleContenido = document.getElementById('detalle-contenido');
const cerrarInfoPanelBtn = document.getElementById('cerrar-info-panel');
const conocimientosComunesContainer = document.getElementById('comunes-container');
const aprobarRamoBtn = document.getElementById('aprobar-ramo-btn'); // Nuevo botón

// --- Gestión del estado de materias aprobadas ---
let materiasAprobadas = new Set(JSON.parse(localStorage.getItem('materiasAprobadas')) || []);

// Función para verificar si una materia está aprobada
function estaAprobada(codigoMateria) {
    return materiasAprobadas.has(codigoMateria);
}

// Función para verificar si una materia está desbloqueada
function estaDesbloqueada(materia) {
    if (!materia.correlatividad || materia.correlatividad === "") {
        return true; // No tiene correlatividad, está desbloqueada por defecto
    }

    const prerequisitos = materia.correlatividad.split('/').map(c => c.trim());
    return prerequisitos.every(prereq => estaAprobada(prereq));
}

// Función para cambiar el estado de aprobación de una materia
function toggleAprobada(materia) {
    const codigo = materia.codigo;
    if (estaAprobada(codigo)) {
        materiasAprobadas.delete(codigo); // Desaprobar
    } else {
        // Antes de aprobar, verificar si todos los pre-requisitos están aprobados
        if (!materia.correlatividad || materia.correlatividad === "") { // No tiene correlatividad
            materiasAprobadas.add(codigo);
        } else {
            const prerequisitos = materia.correlatividad.split('/').map(c => c.trim());
            const todosLosPrerequisitosAprobados = prerequisitos.every(prereq => estaAprobada(prereq));

            if (todosLosPrerequisitosAprobados) {
                materiasAprobadas.add(codigo);
            } else {
                alert('No puedes aprobar esta materia hasta que hayas aprobado todas sus correlatividades.');
                return; // No se aprueba
            }
        }
    }
    localStorage.setItem('materiasAprobadas', JSON.stringify(Array.from(materiasAprobadas)));
    actualizarEstadoMalla(); // Actualizar la visualización de toda la malla
    mostrarDetallesMateria(materia); // Volver a mostrar detalles para actualizar el botón
}

// --- Renderizado y Actualización Visual ---

// Función para renderizar la malla curricular (inicialmente y después de actualizaciones)
function renderizarMalla() {
    mallaCurricular.innerHTML = ''; // Limpiar contenido existente

    planDeEstudiosData.años.forEach(añoData => {
        const añoDiv = document.createElement('section');
        añoDiv.classList.add('año-academico');
        añoDiv.innerHTML = `<h3 class="año-titulo">${añoData.año}</h3>`;

        const cuatrimestreContainer = document.createElement('div');
        cuatrimestreContainer.classList.add('cuatrimestre-container');

        añoData.cuatrimestres.forEach(cuatrimestreData => {
            const cuatrimestreDiv = document.createElement('div');
            cuatrimestreDiv.classList.add('cuatrimestre');
            cuatrimestreDiv.innerHTML = `<h4 class="cuatrimestre-titulo">${cuatrimestreData.cuatrimestre}</h4>`;

            const materiasUl = document.createElement('ul');
            materiasUl.classList.add('materias-lista');

            cuatrimestreData.materias.forEach(materia => {
                const materiaLi = document.createElement('li');
                materiaLi.classList.add('materia-item');
                materiaLi.dataset.codigo = materia.codigo;
                materiaLi.textContent = `${materia.asignatura} (${materia.codigo})`;
                materiasUl.appendChild(materiaLi);

                materiaLi.addEventListener('click', () => mostrarDetallesMateria(materia));
            });
            cuatrimestreDiv.appendChild(materiasUl);
            cuatrimestreContainer.appendChild(cuatrimestreDiv);
        });
        añoDiv.appendChild(cuatrimestreContainer);
        mallaCurricular.appendChild(añoDiv);
    });
    actualizarEstadoMalla(); // Aplicar clases de estado después de renderizar
}

// Función para renderizar los conocimientos comunes
function renderizarConocimientosComunes() {
    conocimientosComunesContainer.innerHTML = ''; // Limpiar contenido existente
    planDeEstudiosData.conocimientos_comunes_unlam.forEach(conocimiento => {
        const conocimientoDiv = document.createElement('div');
        conocimientoDiv.classList.add('conocimiento-comun-item');
        conocimientoDiv.dataset.codigo = conocimiento.codigo; // Para aplicar clases de estado
        conocimientoDiv.textContent = `${conocimiento.asignatura} (${conocimiento.codigo})`;
        conocimientosComunesContainer.appendChild(conocimientoDiv);

        conocimientoDiv.addEventListener('click', () => mostrarDetallesMateria(conocimiento));
    });
    actualizarEstadoMalla(); // Aplicar clases de estado
}


// Función principal para actualizar las clases CSS de todas las materias
function actualizarEstadoMalla() {
    const todasLasMaterias = [];

    // Recolectar todas las materias (de la malla y conocimientos comunes) en un solo array
    planDeEstudiosData.años.forEach(año => {
        año.cuatrimestres.forEach(cuatrimestre => {
            cuatrimestre.materias.forEach(materia => todasLasMaterias.push(materia));
        });
    });
    planDeEstudiosData.conocimientos_comunes_unlam.forEach(conocimiento => todasLasMaterias.push(conocimiento));


    document.querySelectorAll('.materia-item, .conocimiento-comun-item').forEach(itemElement => {
        const codigo = itemElement.dataset.codigo;
        const materia = todasLasMaterias.find(m => m.codigo === codigo);

        if (!materia) return; // Si por alguna razón no encuentra la materia, salta

        // Limpiar todas las clases de estado antes de re-aplicar
        itemElement.classList.remove('aprobada', 'desbloqueada', 'bloqueada', 'materia-activa', 'materia-correlativa', 'materia-requerida');

        if (estaAprobada(codigo)) {
            itemElement.classList.add('aprobada');
        } else if (estaDesbloqueada(materia)) {
            itemElement.classList.add('desbloqueada');
        } else {
            itemElement.classList.add('bloqueada');
        }
    });
}


// Función para mostrar detalles de la materia y resaltar correlativas
let materiaActualSeleccionada = null; // Para almacenar la materia que se está viendo en el panel

function mostrarDetallesMateria(materiaSeleccionada) {
    materiaActualSeleccionada = materiaSeleccionada; // Guardar la referencia

    // Limpiar clases de resaltado anteriores
    document.querySelectorAll('.materia-item, .conocimiento-comun-item').forEach(item => {
        item.classList.remove('materia-activa', 'materia-correlativa', 'materia-requerida');
    });

    // Resaltar la materia seleccionada
    const materiaActivaElement = document.querySelector(`[data-codigo="${materiaSeleccionada.codigo}"]`);
    if (materiaActivaElement) {
        materiaActivaElement.classList.add('materia-activa');
    }

    // Actualizar el texto del botón "Aprobar Ramo"
    if (estaAprobada(materiaSeleccionada.codigo)) {
        aprobarRamoBtn.textContent = 'Desaprobar Ramo';
        aprobarRamoBtn.classList.add('desaprobar');
    } else {
        aprobarRamoBtn.textContent = 'Aprobar Ramo';
        aprobarRamoBtn.classList.remove('desaprobar');
    }

    // Mostrar detalles en el panel lateral
    detalleContenido.innerHTML = `
        <p><strong>Asignatura:</strong> ${materiaSeleccionada.asignatura}</p>
        <p><strong>Código:</strong> ${materiaSeleccionada.codigo}</p>
        <p><strong>Horas Semanales:</strong> ${materiaSeleccionada.horas_semanales}</p>
        <p><strong>Total de Horas:</strong> ${materiaSeleccionada.total_horas}</p>
        <p><strong>Correlatividad:</strong> ${materiaSeleccionada.correlatividad || 'Ninguna'}</p>
    `;

    infoMateriaPanel.classList.add('open'); // Abrir el panel lateral

    // --- Lógica para resaltar correlativas (parte más compleja) ---
    const todasLasMaterias = [];
    planDeEstudiosData.años.forEach(año => {
        año.cuatrimestres.forEach(cuatrimestre => {
            cuatrimestre.materias.forEach(materia => todasLasMaterias.push(materia));
        });
    });
    planDeEstudiosData.conocimientos_comunes_unlam.forEach(conocimiento => todasLasMaterias.push(conocimiento));


    // 1. Identificar materias requeridas (pre-requisitos)
    if (materiaSeleccionada.correlatividad) {
        const requeridas = materiaSeleccionada.correlatividad.split('/').map(c => c.trim());
        requeridas.forEach(reqCode => {
            const reqElement = document.querySelector(`[data-codigo="${reqCode}"]`);
            if (reqElement) {
                reqElement.classList.add('materia-requerida');
            }
        });
    }

    // 2. Identificar materias que esta materia habilita (post-requisitos)
    todasLasMaterias.forEach(materia => {
        if (materia.correlatividad) {
            const correlativasDeMateria = materia.correlatividad.split('/').map(c => c.trim());
            if (correlativasDeMateria.includes(materiaSeleccionada.codigo)) {
                const habilitaElement = document.querySelector(`[data-codigo="${materia.codigo}"]`);
                if (habilitaElement) {
                    habilitaElement.classList.add('materia-correlativa');
                }
            }
        }
    });

    actualizarEstadoMalla(); // Re-aplicar clases de estado para asegurar la visualización correcta
}

// Event listener para cerrar el panel de información
cerrarInfoPanelBtn.addEventListener('click', () => {
    infoMateriaPanel.classList.remove('open');
    // Quitar todos los resaltados cuando se cierra el panel
    document.querySelectorAll('.materia-item, .conocimiento-comun-item').forEach(item => {
        item.classList.remove('materia-activa', 'materia-correlativa', 'materia-requerida');
    });
    materiaActualSeleccionada = null; // Limpiar la referencia
    actualizarEstadoMalla(); // Re-aplicar clases de estado
});

// Event listener para el botón "Aprobar Ramo"
aprobarRamoBtn.addEventListener('click', () => {
    if (materiaActualSeleccionada) {
        toggleAprobada(materiaActualSeleccionada);
    }
});


// Inicializar la renderización cuando el DOM esté cargado
document.addEventListener('DOMContentLoaded', () => {
    renderizarMalla();
    renderizarConocimientosComunes();
});
